name: Build Executables

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.5.0
  workflow_dispatch:  # Allows manual triggering from GitHub UI (builds only, no release)

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: bash -el {0}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: '3.11'
          miniforge-version: latest
          activate-environment: cad_env
          auto-activate-base: false

      - name: Install dependencies
        run: |
          conda install -c conda-forge -y \
            pyside6 \
            build123d \
            ocp \
            vtk \
            pyvista \
            pyvistaqt \
            numpy \
            scipy \
            shapely \
            ezdxf \
            loguru \
            trimesh \
            matplotlib \
            pillow \
            lib3mf
          pip install pyinstaller ocp-tessellate

      - name: Verify imports
        run: |
          python -c "import PySide6; print('PySide6 OK')"
          python -c "import pyvista; print('PyVista OK')"
          python -c "import lib3mf; print('lib3mf OK')"
          python -c "import build123d; print('build123d OK')"
          python -c "import ocp_tessellate; print('ocp_tessellate OK')"
          # Show lib3mf.dll location
          python -c "import os, lib3mf; print('lib3mf path:', os.path.dirname(lib3mf.__file__))"

      - name: Build Windows executable
        run: |
          export KMP_DUPLICATE_LIB_OK=TRUE
          pyinstaller MashCAD.spec
        timeout-minutes: 30

      - name: Create Windows archive (7z)
        run: |
          cd dist
          7z a -t7z -mx=9 MashCAD-Windows-x64.7z MashCAD
        shell: pwsh

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: MashCAD-Windows-x64
          path: dist/MashCAD-Windows-x64.7z
          retention-days: 30

  build-linux:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash -el {0}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0 \
            libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 \
            libxcb-render-util0 libxcb-shape0 libdbus-1-3 \
            libgl1-mesa-glx libgl1-mesa-dev libegl1-mesa libxcb-glx0 \
            libxcb1 libx11-xcb1 libglu1-mesa libglu1-mesa-dev \
            libxrender1 libxi6 libxrandr2 libxcursor1 libxcomposite1 \
            libfontconfig1 libfreetype6 \
            p7zip-full

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: '3.11'
          miniforge-version: latest
          activate-environment: cad_env
          auto-activate-base: false

      - name: Install dependencies
        run: |
          conda install -c conda-forge -y \
            pyside6 \
            build123d \
            ocp \
            vtk \
            pyvista \
            pyvistaqt \
            numpy \
            scipy \
            shapely \
            ezdxf \
            loguru \
            trimesh \
            matplotlib \
            pillow \
            lib3mf
          pip install pyinstaller ocp-tessellate

      - name: Verify imports
        run: |
          python -c "import PySide6; print('PySide6 OK')"
          python -c "import pyvista; print('PyVista OK')"
          python -c "import lib3mf; print('lib3mf OK')"
          python -c "import build123d; print('build123d OK')"

      - name: Build Linux executable
        run: |
          export KMP_DUPLICATE_LIB_OK=TRUE
          pyinstaller MashCAD.spec
        timeout-minutes: 30

      - name: Create Linux archive (7z)
        run: |
          cd dist
          7z a -t7z -mx=9 MashCAD-Linux-x86_64.7z MashCAD

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: MashCAD-Linux-x86_64
          path: dist/MashCAD-Linux-x86_64.7z
          retention-days: 30

  create-release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')  # Only create releases on tag pushes
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/MashCAD-Windows-x64/MashCAD-Windows-x64.7z
            artifacts/MashCAD-Linux-x86_64/MashCAD-Linux-x86_64.7z
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
          generate_release_notes: true
          name: MashCAD ${{ github.ref_name }}
          body: |
            ## Downloads

            | Platform | Download |
            |----------|----------|
            | Windows (x64) | `MashCAD-Windows-x64.7z` |
            | Linux (x86_64) | `MashCAD-Linux-x86_64.7z` |

            ### Installation

            **Windows:** Extract with 7-Zip and run `MashCAD.exe`

            **Linux:** Extract with `7z x MashCAD-Linux-x86_64.7z` and run `./MashCAD/MashCAD`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
