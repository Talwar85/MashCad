name: Build Executables

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.5.0
  workflow_dispatch:  # Allows manual triggering from GitHub UI (builds only, no release)

env:
  PYTHON_VERSION: '3.10'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pyinstaller
          # Install from requirements (skip optional ones that may fail)
          pip install PySide6 loguru numpy
          pip install pyvista pyvistaqt vtk
          pip install shapely ezdxf scipy
          pip install trimesh matplotlib pillow
          # OCP/build123d - these are large and may take time
          pip install cadquery-ocp
          pip install build123d
          pip install ocp-tessellate
          # These may fail - that's OK
          pip install pymeshlab || echo "pymeshlab not available"
          pip install pyransac3d || echo "pyransac3d not available"
          pip install gmsh || echo "gmsh not available"
        shell: pwsh

      - name: Create hooks directory
        run: |
          if (!(Test-Path "hooks")) { New-Item -ItemType Directory -Path "hooks" }
          # Create minimal hook file if not exists
          if (!(Test-Path "hooks/hook-lib3mf.py")) {
            Set-Content -Path "hooks/hook-lib3mf.py" -Value "# lib3mf hook`nimport os"
          }
        shell: pwsh

      - name: Verify imports
        run: |
          python -c "import PySide6; print('PySide6 OK')"
          python -c "import pyvista; print('PyVista OK')"
          python -c "import build123d; print('build123d OK')"
          python -c "import ocp_tessellate; print('ocp_tessellate OK')"
        shell: pwsh
        continue-on-error: true

      - name: Build Windows executable
        run: |
          $env:KMP_DUPLICATE_LIB_OK = "TRUE"
          pyinstaller MashCAD.spec
        shell: pwsh
        timeout-minutes: 30

      - name: Cleanup unnecessary files
        run: |
          cd dist/MashCAD
          # Remove unnecessary locales (keep only en/de)
          Get-ChildItem -Path "PySide6/translations" -Exclude "qt_en*","qt_de*","qtbase_en*","qtbase_de*" -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue
          # Remove test files
          Get-ChildItem -Recurse -Include "test_*","*_test.py","tests" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          # Remove __pycache__
          Get-ChildItem -Recurse -Directory -Filter "__pycache__" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        shell: pwsh
        continue-on-error: true

      - name: Create Windows archive (7z)
        run: |
          cd dist
          7z a -t7z -mx=9 -mfb=273 -ms -md=31 -myx=9 MashCAD-Windows-x64.7z MashCAD
        shell: pwsh

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: MashCAD-Windows-x64
          path: dist/MashCAD-Windows-x64.7z
          retention-days: 30

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0 \
            libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 \
            libxcb-render-util0 libxcb-shape0 libdbus-1-3 \
            libgl1-mesa-glx libgl1-mesa-dev libegl1-mesa libxcb-glx0 \
            libxcb1 libx11-xcb1 libglu1-mesa libglu1-mesa-dev \
            libxrender1 libxi6 libxrandr2 libxcursor1 libxcomposite1 \
            libfontconfig1 libfreetype6 \
            p7zip-full

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pyinstaller
          # Install from requirements (skip optional ones that may fail)
          pip install PySide6 loguru numpy
          pip install pyvista pyvistaqt vtk
          pip install shapely ezdxf scipy
          pip install trimesh matplotlib pillow
          # OCP/build123d - these are large and may take time
          pip install cadquery-ocp
          pip install build123d
          pip install ocp-tessellate
          # These may fail - that's OK
          pip install pymeshlab || echo "pymeshlab not available"
          pip install pyransac3d || echo "pyransac3d not available"
          pip install gmsh || echo "gmsh not available"

      - name: Create hooks directory
        run: |
          mkdir -p hooks
          # Create minimal hook file if not exists
          if [ ! -f "hooks/hook-lib3mf.py" ]; then
            echo "# lib3mf hook" > hooks/hook-lib3mf.py
            echo "import os" >> hooks/hook-lib3mf.py
          fi

      - name: Build Linux executable
        run: |
          export KMP_DUPLICATE_LIB_OK=TRUE
          # Modify spec for Linux (no lib3mf.dll)
          sed -i "s|os.path.join(sys.prefix, 'Library', 'bin', 'lib3mf.dll')|'/nonexistent'|g" MashCAD.spec || true
          sed -i "s|binaries=\[|binaries=[  # Linux: no lib3mf|g" MashCAD.spec || true
          pyinstaller MashCAD.spec

      - name: Cleanup unnecessary files
        run: |
          cd dist/MashCAD
          # Remove unnecessary locales
          find . -path "*/translations/*" ! -name "qt_en*" ! -name "qt_de*" ! -name "qtbase_en*" ! -name "qtbase_de*" -type f -delete 2>/dev/null || true
          # Remove test files
          find . -name "test_*" -o -name "*_test.py" | xargs rm -f 2>/dev/null || true
          # Remove __pycache__
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
        continue-on-error: true

      - name: Create Linux archive (7z)
        run: |
          cd dist
          7z a -t7z -mx=9 -mfb=273 -ms -md=31 MashCAD-Linux-x86_64.7z MashCAD

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: MashCAD-Linux-x86_64
          path: dist/MashCAD-Linux-x86_64.7z
          retention-days: 30

  create-release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')  # Only create releases on tag pushes
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/MashCAD-Windows-x64/MashCAD-Windows-x64.7z
            artifacts/MashCAD-Linux-x86_64/MashCAD-Linux-x86_64.7z
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
          generate_release_notes: true
          name: MashCAD ${{ github.ref_name }}
          body: |
            ## Downloads

            | Platform | Download |
            |----------|----------|
            | Windows (x64) | `MashCAD-Windows-x64.7z` |
            | Linux (x86_64) | `MashCAD-Linux-x86_64.7z` |

            ### Installation

            **Windows:** Extract with 7-Zip and run `MashCAD.exe`

            **Linux:** Extract with `7z x MashCAD-Linux-x86_64.7z` and run `./MashCAD/MashCAD`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
