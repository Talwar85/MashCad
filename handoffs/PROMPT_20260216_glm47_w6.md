Du bist GLM 4.7 (UX/WORKFLOW + QA Integration Cell) auf Branch `feature/v1-ux-aiB`.

## Kontext
W5 hat die Basis gelegt (UI-Gate-Hardening + Selection-State Basis + Dossiers), aber fuer V1 fehlen noch die produktionsreifen Umsetzungen in Direct Manipulation und Discoverability.
Du uebernimmst jetzt W6 als grosses Integrationspaket mit Fokus auf echte UX-Wirkung und testbare Contracts.

Lies zuerst vollstaendig:
- `handoffs/HANDOFF_20260216_glm47_w5_megapacks.md`
- `handoffs/HANDOFF_20260216_core_to_glm47_w4.md`
- `handoffs/HANDOFF_20260216_ai3_w5.md`
- `roadmap_ctp/DIRECT_MANIPULATION_CONTRACTS_W5_20260216.md`
- `roadmap_ctp/DISCOVERABILITY_WORKFLOW_W5_20260216.md`
- `roadmap_ctp/SELECTION_STATE_ANALYSIS_W5_20260216.md`
- `roadmap_ctp/UI_GATE_KNOWN_WARNINGS_W5_20260216.md`
- `roadmap_ctp/GATE_DEFINITIONS_20260215.md`

---

## Harte Regeln
1. Nicht editieren:
- `modeling/**`
- `config/feature_flags.py`

2. Fokus (erlaubte Bereiche):
- `gui/**`
- `test/**`
- `scripts/**` (nur QA/Gate/Test-Infra)
- `roadmap_ctp/**`
- `handoffs/**`

3. Keine Placeholders. Keine "done"-Aussage ohne reproduzierbare Commands.

4. Keine Micro-Fixes ohne Paketbegruendung. In W6 nur kohaerente End-to-End Pakete.

5. Jede aenderung mit klarer Contract-Aussage (neu/geaendert/entfaellt).

---

## W6 Mega-Pakete (verbindliche Reihenfolge)

### Paket A (P0): Direct Manipulation Production Rollout
Ziel:
- W5-Dokumentation in produktionsreifes Verhalten ueberfuehren.
- Drag-Vertraege fuer Circle/Rectangle/Line konsistent und testbar machen.

Lieferumfang:
- Circle:
  - Center-Drag verschiebt robust (ohne Radius-Jitter).
  - Radius-Drag aendert Groesse ohne unbeabsichtigte Translation.
- Rectangle:
  - Edge-Drag passt Dimensionen an und respektiert Constraints.
  - Cursor-Semantik korrekt (nicht verdrehte Richtungsicons).
- Line:
  - Direkter Segment-Drag ohne Handle-Sprung oder Cursor-Flattern.
- Interaction-Harness erweitern:
  - Bestehende Skips nur behalten, wenn technisch unvermeidbar und sauber begruendet.
  - Ziel: minimale Skip-Rate bei Kern-Drag-Pfaden.

Abnahme:
- `test/harness/test_interaction_consistency.py`
- Neue/erweiterte Regressionen fuer Circle/Rectangle/Line Drag Contracts


### Paket B (P0): Discoverability Rollout (2D Guidance)
Ziel:
- 2D-Mode selbsterklaerend machen (Peek/Rotate/Abort sichtbar und kontextbasiert).

Lieferumfang:
- Kontextuelle HUD-Hinweise fuer:
  - Peek mit Leertaste
  - Rotation
  - Rechtsklick ins Leere = Aktion abbrechen/clear
- Sichtbarkeit strikt state-basiert:
  - Hinweise nur dann zeigen, wenn sie im aktuellen Tool/Modus relevant sind.
- Konsistenz der Begriffe ueber Statusbar/HUD/Tooltips.

Abnahme:
- deterministische Repro-Checks (state-basierte Sichtbarkeit)
- keine Regression in bestehenden Panels


### Paket C (P1): Selection State Finalization
Ziel:
- W5-Bridge abschliessen und Legacy-Schulden weiter abbauen.

Lieferumfang:
- Zugriffspfad-Migration von Legacy `selected_faces`/`selected_edges` auf Unified API.
- Nur falls sicher: Legacy-Properties als reine Kompatibilitaet belassen, aber intern keine neue Nutzung mehr.
- Regressionen fuer:
  - Escape Clear
  - Right-Click Background Clear
  - Multi-Select
  - Tool-Mode Wechsel

Abnahme:
- `test/test_selection_state_unified.py`
- keine stillen Verhaltensaenderungen in Viewport/Browser


### Paket D (P1): Error UX Contract Completion
Ziel:
- Core Error-Codes als handlungsorientierte UX ausspielen.

Lieferumfang:
- Sichtbare UX fuer:
  - `tnp_ref_missing`
  - `tnp_ref_mismatch`
  - `tnp_ref_drift`
  - `rebuild_finalize_failed`
  - `ocp_api_unavailable`
- `tnp_ref_drift` explizit als recoverable warning kommunizieren (nicht hard-fail).
- Wenn vorhanden: Detailansicht fuer `tnp_failure` Felder (`category`, `reference_kind`, `next_action`).

Abnahme:
- `test/test_browser_tooltip_formatting.py`
- neue Regressionen fuer Warning-vs-Error Semantik


### Paket E (P1): UI Gate Reliability Upgrade
Ziel:
- UI-Gate robust gegen Render-/Lifecycle-Schwankungen halten.

Lieferumfang:
- Weiteres Hardening in UI-Test-Setup/Teardown, ohne reale Fehler zu maskieren.
- Known-Warning-Policy aktualisieren (akzeptierte vs nicht-akzeptierte Warnungen).
- Klarer BLOCKED_INFRA vs FAIL Nachweis im Gate-Output.

Abnahme:
- `test/test_ui_abort_logic.py`
- `test/harness/test_interaction_consistency.py`
- `test/test_gate_runner_contract.py`


### Paket F (P1): W6 Merge-Ready Evidence Pack
Ziel:
- W6 als integrierbares Paket dokumentieren (ohne unklare Restsignale).

Lieferumfang:
- Update relevanter `roadmap_ctp` Evidence-Dateien mit W6-Delta.
- Klare Liste: was ist jetzt wirklich produktionsreif, was bleibt Rest-Risiko.

Abnahme:
- W6-Handoff mit reproduzierbarer Validation und Rest-Risiko-Matrix

---

## Pflicht-Validation (vollstaendig)
```powershell
# UI kritische Suiten
conda run -n cad_env python -m pytest -q test/test_ui_abort_logic.py
conda run -n cad_env python -m pytest -q test/harness/test_interaction_consistency.py -vv

# Selection-State
conda run -n cad_env python -m pytest -q test/test_selection_state_unified.py

# Error UX
conda run -n cad_env python -m pytest -q test/test_browser_tooltip_formatting.py test/test_feature_commands_atomic.py

# Gate Runner Contract
conda run -n cad_env python -m pytest -q test/test_gate_runner_contract.py

# Optional: gebuendelter Lauf
conda run -n cad_env python -m pytest -q test/test_ui_abort_logic.py test/harness/test_interaction_consistency.py test/test_selection_state_unified.py test/test_browser_tooltip_formatting.py test/test_feature_commands_atomic.py test/test_gate_runner_contract.py
```

---

## Rueckgabeformat (verpflichtend)
Datei: `handoffs/HANDOFF_20260216_glm47_w6.md`

Struktur:
1. Problem
2. Read Acknowledgement (jede Datei + 1 Satz Impact)
3. API/Behavior Contract (neu/geaendert/entfaellt)
4. Impact (Dateien + Kernveraenderungen)
5. Validation (alle Commands + exakte Resultate)
6. Breaking Changes / Rest-Risiken
7. Gate Delta W5 -> W6
8. Naechste 5 priorisierte Folgepakete (mit Owner + ETA)

Wichtig:
- Bei Rot/Skip: exakte Repro, Root-Cause-Hypothese, naechster konkreter Fixschritt.
- Kein Sammeltext ohne harte Evidenz.
